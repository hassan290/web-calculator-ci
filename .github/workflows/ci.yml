name: CI Pipeline

on: [push]

env:
  IMAGE_TAG: web-calculator:${{ github.sha }}
  APP_START_TIMEOUT: 60

jobs:
  # -------------
  # Build
  # -------------
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ env.IMAGE_TAG }}
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -t $IMAGE_TAG .

  # -------------
  # Unit tests
  # -------------
  unit_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run unit tests
        run: |
          pip install -r requirements.txt
          python -m pytest tests/unit_tests/ -v --junitxml=unit-results.xml
      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: unit-results.xml

  # -------------
  # Functional tests
  # -------------
  functional_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Build and start application
        run: |
          docker build -t ${{ needs.build.outputs.image_tag }} .
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Wait for app
        run: |
          timeout $APP_START_TIMEOUT bash -c 'until curl -f http://localhost:5000/; do sleep 2; done'
      - name: Run functional tests
        run: |
          pip install -r requirements.txt
          python -m pytest tests/functional_tests/ --url=http://localhost:5000 -v --junitxml=functional-results.xml
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: functional-test-results
          path: functional-results.xml
      - name: Cleanup
        run: docker rm -f app || true

  # -------------
  # Curl tests
  # -------------
  curl_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Build and start application
        run: |
          docker build -t ${{ needs.build.outputs.image_tag }} .
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Wait for app
        run: |
          timeout $APP_START_TIMEOUT bash -c 'until curl -f http://localhost:5000/; do sleep 2; done'
      - name: Run curl tests
        run: |
          {
            echo "ðŸ§ª Running curl tests..."
            echo "=========================="
            curl -f http://localhost:5000/ && echo "âœ… Root OK"
            curl -f "http://localhost:5000/add/2&3" && echo "âœ… Add OK"
            curl -f "http://localhost:5000/multiply/3&4" && echo "âœ… Multiply OK"
            curl -f "http://localhost:5000/subtract/10&4" && echo "âœ… Subtract OK"
            curl -f "http://localhost:5000/divide/20&5" && echo "âœ… Divide OK"
            echo "=========================="
            echo "ðŸŽ‰ All curl tests passed!"
          } > curl-report.txt
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: curl-test-results
          path: curl-report.txt
      - name: Cleanup
        run: docker rm -f app || true

  # -------------
  # Postman tests (Conditional)
  # -------------
  postman_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Check if Postman collection exists
        id: check_postman
        run: |
          if [ -f "tests/postman/collection.json" ]; then
            echo "Postman collection found"
            echo "run_postman=true" >> $GITHUB_OUTPUT
          else
            echo "Postman collection not found, skipping..."
            echo "run_postman=false" >> $GITHUB_OUTPUT
          fi
      - name: Build and start application
        if: steps.check_postman.outputs.run_postman == 'true'
        run: |
          docker build -t ${{ needs.build.outputs.image_tag }} .
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Wait for app
        if: steps.check_postman.outputs.run_postman == 'true'
        run: |
          timeout $APP_START_TIMEOUT bash -c 'until curl -f http://localhost:5000/; do sleep 2; done'
      - name: Install Newman
        if: steps.check_postman.outputs.run_postman == 'true'
        run: npm install -g newman
      - name: Run Postman tests
        if: steps.check_postman.outputs.run_postman == 'true'
        run: |
          newman run tests/postman/collection.json \
            --env-var "baseUrl=http://localhost:5000" \
            --reporters cli,junit \
            --reporter-junit-export postman-results.xml
      - name: Create dummy Postman report
        if: steps.check_postman.outputs.run_postman == 'false'
        run: |
          echo "Postman tests skipped - no collection found" > postman-results.xml
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: postman-test-results
          path: postman-results.xml
      - name: Cleanup
        if: steps.check_postman.outputs.run_postman == 'true'
        run: docker rm -f app || true

  # -------------
  # Selenium tests (Conditional)
  # -------------
  selenium_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Check if Selenium tests exist
        id: check_selenium
        run: |
          if [ -d "tests/selenium" ] && [ -n "$(find tests/selenium -name '*.py' -o -name '*.js')" ]; then
            echo "Selenium tests found"
            echo "run_selenium=true" >> $GITHUB_OUTPUT
          else
            echo "Selenium tests not found, skipping..."
            echo "run_selenium=false" >> $GITHUB_OUTPUT
          fi
      - name: Build and start application
        if: steps.check_selenium.outputs.run_selenium == 'true'
        run: |
          docker build -t ${{ needs.build.outputs.image_tag }} .
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Start Selenium
        if: steps.check_selenium.outputs.run_selenium == 'true'
        run: |
          docker run -d -p 4444:4444 --name selenium --shm-size=2g selenium/standalone-chrome:latest
      - name: Wait for services
        if: steps.check_selenium.outputs.run_selenium == 'true'
        run: |
          timeout $APP_START_TIMEOUT bash -c 'until curl -f http://localhost:5000/ && curl -f http://localhost:4444/wd/hub/status; do sleep 2; done'
      - name: Run Selenium tests
        if: steps.check_selenium.outputs.run_selenium == 'true'
        run: |
          pip install pytest selenium webdriver-manager
          python -m pytest tests/selenium/ --base-url=http://localhost:5000 --selenium-url=http://localhost:4444/wd/hub -v --junitxml=selenium-results.xml
      - name: Create dummy Selenium report
        if: steps.check_selenium.outputs.run_selenium == 'false'
        run: |
          echo "Selenium tests skipped - no tests found" > selenium-results.xml
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: selenium-test-results
          path: selenium-results.xml
      - name: Cleanup
        if: steps.check_selenium.outputs.run_selenium == 'true'
        run: docker rm -f app selenium || true

  # -------------
  # Package release
  # -------------
  package_release:
    runs-on: ubuntu-latest
    needs: [unit_tests, functional_tests, curl_tests, postman_tests, selenium_tests]
    steps:
      - uses: actions/checkout@v4
      - name: Create release package
        run: |
          zip -r web-calculator-release.zip . -x "*.git*" "*.github*" "*.pytest_cache*" "__pycache__/*"
      - name: Upload release
        uses: actions/upload-artifact@v4
        with:
          name: web-calculator-release
          path: web-calculator-release.zip