name: CI Pipeline

on: [push]

env:
  IMAGE_TAG: web-calculator:${{ github.sha }}
  APP_START_TIMEOUT: 60

jobs:
  # -------------
  # Build + Push image
  # -------------
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        id: build
        run: |
          docker build -t $IMAGE_TAG .
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
      - name: Save Docker image
        run: docker save $IMAGE_TAG -o web-calculator-image.tar
      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: web-calculator-image.tar

  # -------------
  # Unit tests
  # -------------
  unit_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Run unit tests
        run: |
          pip install -r requirements.txt
          python -m pytest tests/unit_tests/ -v --junitxml=unit-results.xml
      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: unit-results.xml

  # -------------
  # Functional tests
  # -------------
  functional_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Start application
        run: |
          docker load -i docker-image.tar
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Wait for app
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5000/; do sleep 2; done'
      - name: Run functional tests
        run: |
          pip install -r requirements.txt
          python -m pytest tests/functional_tests/ --url=http://localhost:5000 -v --junitxml=functional-results.xml
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: functional-test-results
          path: functional-results.xml
      - name: Cleanup
        run: docker rm -f app || true

  # -------------
  # Curl tests
  # -------------
  curl_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Start application
        run: |
          docker load -i docker-image.tar
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Wait for app
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5000/; do sleep 2; done'
      - name: Run curl tests
        run: |
          echo "ðŸ§ª Running curl tests..." > curl-report.txt
          curl -f http://localhost:5000/ >> curl-report.txt && echo "âœ… Root OK" >> curl-report.txt
          curl -f "http://localhost:5000/add/2&3" >> curl-report.txt && echo "âœ… Add OK" >> curl-report.txt
          curl -f "http://localhost:5000/multiply/3&4" >> curl-report.txt && echo "âœ… Multiply OK" >> curl-report.txt
          curl -f "http://localhost:5000/subtract/10&4" >> curl-report.txt && echo "âœ… Subtract OK" >> curl-report.txt
          curl -f "http://localhost:5000/divide/20&5" >> curl-report.txt && echo "âœ… Divide OK" >> curl-report.txt
          echo "ðŸŽ‰ All curl tests passed!" >> curl-report.txt
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: curl-test-results
          path: curl-report.txt
      - name: Cleanup
        run: docker rm -f app || true

  # -------------
  # Postman tests
  # -------------
  postman_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Start application
        run: |
          docker load -i docker-image.tar
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Wait for app
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5000/; do sleep 2; done'
      - name: Install Newman
        run: npm install -g newman
      - name: Run Postman tests
        run: |
          newman run tests/postman/collection.json \
            --env-var "baseUrl=http://localhost:5000" \
            --reporters cli,junit \
            --reporter-junit-export postman-results.xml
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: postman-test-results
          path: postman-results.xml
      - name: Cleanup
        run: docker rm -f app || true

  # -------------
  # Selenium tests
  # -------------
  selenium_tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Start application
        run: |
          docker load -i docker-image.tar
          docker run -d -p 5000:5000 --name app ${{ needs.build.outputs.image_tag }}
      - name: Start Selenium
        run: |
          docker run -d -p 4444:4444 --name selenium --shm-size=2g selenium/standalone-chrome:latest
      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:5000/ && curl -f http://localhost:4444/wd/hub/status; do sleep 2; done'
      - name: Run Selenium tests
        run: |
          pip install pytest selenium webdriver-manager
          python -m pytest tests/selenium/ --base-url=http://localhost:5000 --selenium-url=http://localhost:4444/wd/hub -v --junitxml=selenium-results.xml
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: selenium-test-results
          path: selenium-results.xml
      - name: Cleanup
        run: docker rm -f app selenium || true

  # -------------
  # Package release
  # -------------
  package_release:
    runs-on: ubuntu-latest
    needs: [build, unit_tests, functional_tests, curl_tests, postman_tests, selenium_tests]
    steps:
      - uses: actions/checkout@v4
      - name: Create release package
        run: |
          zip -r web-calculator-release.zip . -x "*.git*" "*.github*" "*.pytest_cache*" "__pycache__/*"
      - name: Upload release
        uses: actions/upload-artifact@v4
        with:
          name: web-calculator-release
          path: web-calculator-release.zip